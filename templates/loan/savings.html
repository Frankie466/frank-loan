{% extends 'loan/base.html' %}

{% block content %}
<div class="container py-5">
    <!-- 
    <div class="alert alert-info mb-4">
        <h6>Debug Information:</h6>
        <p>Number of savings options: {{ savings_options|length }}</p>
        {% if savings_options %}
            <p>First option details:</p>
            <ul>
                <li>ID: {{ savings_options.0.id }}</li>
                <li>Amount: {{ savings_options.0.amount }}</li>
                <li>Savings: {{ savings_options.0.savings }}</li>
            </ul>
        {% else %}
            <p>No savings options available</p>
        {% endif %}
        {% if attempted_withdrawal %}
            <p>Attempted Withdrawal: {{ attempted_withdrawal }}</p>
            <p>Required Savings: {{ required_savings }}</p>
        {% endif %}
    </div>
     -->

    <div class="text-center mb-5">
        <div class="mb-3">
            <i class="bi bi-piggy-bank-fill text-danger" style="font-size: 2.5rem;"></i>
        </div>
        <h3 class="mb-2 text-dark fw-bold">Savings Top-Up Required</h3>
        <p class="text-muted fs-5">To qualify for this loan, please select a savings top-up option below</p>
        
        <!-- Show current savings if available -->
        {% if current_savings %}
        <div class="alert alert-info d-inline-flex align-items-center py-2 px-4 rounded-pill mt-3">
            <i class="bi bi-wallet2 me-2"></i>
            <span class="fw-semibold">Current Savings:</span>
            <span class="fw-bold ms-2">Ksh {{ current_savings|floatformat:2 }}</span>
        </div>
        {% endif %}
    </div>

    <div class="row justify-content-center g-4">
        {% for option in savings_options %}
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column p-4">
                    <div class="mb-3">
                        <span class="badge bg-success bg-opacity-10 text-success mb-2">Loan Option {{ forloop.counter }}</span>
                        <h5 class="card-title text-dark fw-semibold">Loan: Ksh {{ option.amount|floatformat:2 }}</h5>
                    </div>
                    <div class="mb-4">
                        <p class="text-muted mb-1">Required Savings:</p>
                        <h4 class="text-success fw-bold">Ksh 
                            {% if option.savings %}
                                {{ option.savings|floatformat:2 }}
                            {% else %}
                                0.00
                            {% endif %}
                        </h4>
                    </div>
                    
                    <!-- Additional Information -->
                    <div class="mt-auto">
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted">You Pay:</small>
                            <small class="fw-bold">Ksh {{ option.amount|floatformat:2 }}</small>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted">You Save:</small>
                            <small class="fw-bold text-success">Ksh 
                                {% if option.savings %}
                                    {{ option.savings|floatformat:2 }}
                                {% else %}
                                    0.00
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary mt-3 align-self-stretch" data-bs-toggle="modal" data-bs-target="#modal{{ option.id }}">
                        <i class="bi bi-arrow-up-circle me-2"></i>Top Up Now
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="modal{{ option.id }}" tabindex="-1" aria-labelledby="modalLabel{{ option.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0">
                    <div class="modal-header border-0 pb-0">
                        <div>
                            <h5 class="modal-title fw-bold" id="modalLabel{{ option.id }}">Complete Your Top-Up</h5>
                            <p class="text-muted small">Follow these steps to qualify for your loan</p>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body pt-1">
                        <div class="alert alert-info border-0 bg-light">
                            <div class="d-flex">
                                <i class="bi bi-info-circle-fill text-info me-2"></i>
                                <div>
                                    <strong>Top Up Amount:</strong> Ksh {{ option.amount|floatformat:2 }}<br>
                                    <strong>Savings Added:</strong> Ksh 
                                    {% if option.savings %}
                                        {{ option.savings|floatformat:2 }}
                                    {% else %}
                                        0.00
                                    {% endif %}
                                    <br>
                                    <strong>Loan Available:</strong> Ksh {{ option.amount|floatformat:2 }}
                                </div>
                            </div>
                        </div>

                        <div class="bg-light rounded p-3 mb-4">
                            <h6 class="fw-bold mb-3">M-Pesa Payment Instructions</h6>
                            <ol class="list-group list-group-numbered list-group-flush">
                                <li class="list-group-item bg-transparent ps-0 pe-0 py-1 border-0">Open your M-Pesa menu</li>
                                <li class="list-group-item bg-transparent ps-0 pe-0 py-1 border-0">Select <span class="badge bg-primary bg-opacity-10 text-primary">Lipa na M-Pesa</span></li>
                                <li class="list-group-item bg-transparent ps-0 pe-0 py-1 border-0">Choose <span class="badge bg-primary bg-opacity-10 text-primary">Buy Goods and Services</span></li>
                                <li class="list-group-item bg-transparent ps-0 pe-0 py-1 border-0">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>Enter Till Number:</span>
                                        <div class="input-group ms-2" style="width: 150px;">
                                            <input type="text" id="tillInput{{ option.id }}" class="form-control form-control-sm" value="3750234" readonly>
                                            <button class="btn btn-light btn-sm border-secondary" type="button" onclick="copyTill({{ option.id }})" style="min-width: 80px;">
                                                <i class="bi bi-copy me-1"></i> Copy
                                            </button>
                                        </div>
                                    </div>
                                </li>
                                <li class="list-group-item bg-transparent ps-0 pe-0 py-1 border-0">
                                    Enter Amount: <span class="badge bg-success bg-opacity-10 text-success">Ksh {{ option.amount|floatformat:2 }}</span>
                                </li>
                                <li class="list-group-item bg-transparent ps-0 pe-0 py-1 border-0">Enter your M-Pesa PIN and confirm</li>
                            </ol>
                        </div>

                        <div class="mb-3">
                            <label for="transactionCode{{ option.id }}" class="form-label fw-semibold">Transaction Code</label>
                            <input type="text" class="form-control" id="transactionCode{{ option.id }}" placeholder="Enter M-Pesa transaction code">
                            <small class="text-muted">Found in your M-Pesa confirmation message</small>
                        </div>

                        <!-- Payment Form -->
                        <form method="POST" action="{% url 'process_savings' %}">
                            {% csrf_token %}
                            <input type="hidden" name="savings_option" value="{{ option.id }}">
                            
                            <div class="text-center mt-4">
                                <button type="submit" id="confirmBtn{{ option.id }}" class="btn btn-success px-5 py-2">
                                    <span id="btnText{{ option.id }}">Confirm Payment</span>
                                    <span id="btnSpinner{{ option.id }}" class="spinner-border spinner-border-sm d-none" role="status"></span>
                                </button>
                            </div>
                        </form>

                        <div class="text-center mt-3">
                            <p class="small text-muted">
                                <i class="bi bi-shield-lock me-1"></i> Payments are processed securely
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-warning text-center py-5">
                <i class="bi bi-exclamation-triangle-fill fs-1 mb-3"></i>
                <h4>No Savings Options Available</h4>
                <p class="mb-0">Please contact support for assistance.</p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- JS: Copy Till and Confirmation Animation -->
<script>
    function copyTill(id) {
        const input = document.getElementById(`tillInput${id}`);
        input.select();
        input.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(input.value)
            .then(() => {
                // Show feedback
                const copyBtn = input.nextElementSibling;
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="bi bi-check me-1"></i>Copied!';
                copyBtn.classList.remove('btn-light');
                copyBtn.classList.add('btn-success');
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                    copyBtn.classList.remove('btn-success');
                    copyBtn.classList.add('btn-light');
                }, 2000);
            })
            .catch(err => {
                console.error('Failed to copy: ', err);
                alert('Please copy manually: ' + input.value);
            });
    }

    // Handle form submission
    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const submitBtn = this.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('#btnText' + this.querySelector('input[name="savings_option"]').value);
            const spinner = submitBtn.querySelector('#btnSpinner' + this.querySelector('input[name="savings_option"]').value);
            
            if (btnText && spinner) {
                // Show loading state
                submitBtn.disabled = true;
                btnText.textContent = 'Processing...';
                spinner.classList.remove('d-none');
            }
        });
    });

    // Initialize tooltips
    $(function () {
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>

<style>
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border-radius: 12px;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .modal-content {
        border-radius: 16px;
        overflow: hidden;
    }
</style>
{% endblock %}