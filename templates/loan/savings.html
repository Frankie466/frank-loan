{% extends 'loan/base.html' %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5">
        <div class="mb-3">
            <i class="bi bi-piggy-bank-fill text-danger" style="font-size: 2.5rem;"></i>
        </div>
        <h3 class="mb-2 text-dark fw-bold">Savings Top-Up Required</h3>
        <p class="text-muted fs-5">To qualify for this loan, please select a savings top-up option below</p>
        
        <!-- Show current savings if available -->
        {% if current_savings %}
        <div class="alert alert-info d-inline-flex align-items-center py-2 px-4 rounded-pill mt-3">
            <i class="bi bi-wallet2 me-2"></i>
            <span class="fw-semibold">Current Savings:</span>
            <span class="fw-bold ms-2">Ksh {{ current_savings|floatformat:2 }}</span>
        </div>
        {% endif %}
    </div>

    <div class="row justify-content-center g-4">
        {% for option in savings_options %}
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column p-4">
                    <div class="mb-3">
                        <span class="badge bg-success bg-opacity-10 text-success mb-2">Option {{ forloop.counter }}</span>
                        <h5 class="card-title text-dark fw-semibold">Loan Amount: Ksh {{ option.amount|floatformat:2 }}</h5>
                    </div>
                    <div class="mb-4">
                        <p class="text-muted mb-1">Savings Required:</p>
                        <h4 class="text-success fw-bold">Ksh 
                            {% if option.savings %}
                                {{ option.savings|floatformat:2 }}
                            {% else %}
                                0.00
                            {% endif %}
                        </h4>
                    </div>
                    
                    <!-- Additional Information -->
                    <div class="mt-auto">
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted">You Pay:</small>
                            <small class="fw-bold">Ksh {{ option.amount|floatformat:2 }}</small>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <small class="text-muted">Savings Added:</small>
                            <small class="fw-bold text-success">Ksh 
                                {% if option.savings %}
                                    {{ option.savings|floatformat:2 }}
                                {% else %}
                                    0.00
                                {% endif %}
                            </small>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary mt-3 align-self-stretch" data-bs-toggle="modal" data-bs-target="#modal{{ option.id }}">
                        <i class="bi bi-arrow-up-circle me-2"></i>Pay Now
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="modal{{ option.id }}" tabindex="-1" aria-labelledby="modalLabel{{ option.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0">
                    <div class="modal-header border-0 pb-0">
                        <div>
                            <h5 class="modal-title fw-bold" id="modalLabel{{ option.id }}">Complete Your Payment</h5>
                            <p class="text-muted small">Follow these simple steps to make your payment</p>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body pt-1">
                        <div class="alert alert-info border-0 bg-light">
                            <div class="d-flex">
                                <i class="bi bi-info-circle-fill text-info me-2"></i>
                                <div>
                                    <strong>Loan Amount:</strong> Ksh {{ option.amount|floatformat:2 }}<br>
                                    <strong>Savings Required:</strong> Ksh 
                                    {% if option.savings %}
                                        {{ option.savings|floatformat:2 }}
                                    {% else %}
                                        0.00
                                    {% endif %}
                                    <br>
                                    <strong>Total Available:</strong> Ksh {{ option.savings|add:option.amount|floatformat:2 }}
                                </div>
                            </div>
                        </div>

                        <div class="bg-light rounded p-3 mb-4">
                            <h6 class="fw-bold mb-3">Payment Instructions</h6>
                            
                            <div class="alert alert-primary border-0 bg-primary bg-opacity-10 mb-3">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-phone-fill text-primary fs-5 me-2"></i>
                                    <div>
                                        <p class="mb-1 fw-semibold">STK Push Payment Method</p>
                                        <p class="small mb-0">You'll receive an STK push notification on your phone</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="step-by-step">
                                <div class="step d-flex mb-3">
                                    <div class="step-number bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px; min-width: 32px;">
                                        1
                                    </div>
                                    <div class="step-content">
                                        <h6 class="fw-semibold mb-1">Click "Proceed to Payment"</h6>
                                        <p class="small text-muted mb-0">You'll be redirected to our secure payment page</p>
                                    </div>
                                </div>
                                
                                <div class="step d-flex mb-3">
                                    <div class="step-number bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px; min-width: 32px;">
                                        2
                                    </div>
                                    <div class="step-content">
                                        <h6 class="fw-semibold mb-1">Enter Your Phone Number</h6>
                                        <p class="small text-muted mb-0">Input your M-Pesa registered phone number</p>
                                    </div>
                                </div>
                                
                                <div class="step d-flex mb-3">
                                    <div class="step-number bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px; min-width: 32px;">
                                        3
                                    </div>
                                    <div class="step-content">
                                        <h6 class="fw-semibold mb-1">Enter Amount: <span class="text-success">Ksh {{ option.savings|floatformat:2 }}</span></h6>
                                        <p class="small text-muted mb-0">Enter the savings amount shown above</p>
                                    </div>
                                </div>
                                
                                <div class="step d-flex mb-3">
                                    <div class="step-number bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px; min-width: 32px;">
                                        4
                                    </div>
                                    <div class="step-content">
                                        <h6 class="fw-semibold mb-1">Confirm Payment</h6>
                                        <p class="small text-muted mb-0">You'll receive an STK push notification on your phone</p>
                                    </div>
                                </div>
                                
                                <div class="step d-flex">
                                    <div class="step-number bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 32px; height: 32px; min-width: 32px;">
                                        5
                                    </div>
                                    <div class="step-content">
                                        <h6 class="fw-semibold mb-1">Enter Your M-Pesa PIN</h6>
                                        <p class="small text-muted mb-0">Enter your PIN on the STK push to complete</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-success border-0 bg-success bg-opacity-10 mt-3">
                                <div class="d-flex align-items-start">
                                    <i class="bi bi-shield-check text-success fs-5 me-2"></i>
                                    <div>
                                        <p class="mb-0 fw-semibold">Secure Payment</p>
                                        <p class="small mb-0">Your payment is processed securely through encrypted channels</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Information -->
                        <div class="mb-4">
                            <div class="card border-0 bg-light">
                                <div class="card-body">
                                    <h6 class="fw-bold mb-3">Package Summary</h6>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">Loan Amount:</span>
                                        <span class="fw-bold">Ksh {{ option.amount|floatformat:2 }}</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-muted">Savings Required:</span>
                                        <span class="fw-bold text-success">Ksh {{ option.savings|floatformat:2 }}</span>
                                    </div>
                                    <hr class="my-2">
                                    <div class="d-flex justify-content-between">
                                        <span class="fw-semibold">Amount to Withdraw:</span>
                                        <span class="fw-bold text-primary">Ksh {{ option.savings|add:option.amount|floatformat:2 }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Link Only -->
                        <div class="text-center mt-4">
                            <!-- Payment Link Button -->
                            <a href="https://me.nestlink.co.ke/Maramkopo" 
                               target="_blank" 
                               class="btn btn-success px-5 py-3 fw-bold"
                               style="min-width: 250px; font-size: 1.1rem;">
                                <i class="bi bi-arrow-right-circle me-2"></i>
                                Proceed to Payment
                            </a>
                            
                            <p class="small text-muted mt-3 mb-2">
                                <i class="bi bi-lock-fill me-1"></i> You'll be redirected to our secure payment portal
                            </p>
                            <p class="small text-muted mb-4">
                                <i class="bi bi-info-circle me-1"></i> After payment, return to your dashboard to continue
                            </p>
                        </div>

                        <div class="text-center mt-4">
                            <div class="d-flex justify-content-center align-items-center text-muted small">
                                <i class="bi bi-shield-check me-2 text-success"></i>
                                <div class="text-start">
                                    <p class="mb-1"><strong>Payment Security:</strong></p>
                                    <ul class="list-unstyled small mb-0">
                                        <li>• Encrypted transaction</li>
                                        <li>• No PIN stored on our servers</li>
                                        <li>• Instant payment confirmation</li>
                                        <li>• Multiple payment methods available</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-warning text-center py-5">
                <i class="bi bi-exclamation-triangle-fill fs-1 mb-3"></i>
                <h4>No Savings Options Available</h4>
                <p class="mb-0">Please contact support for assistance.</p>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Information Section -->
    <div class="row mt-5">
        <div class="col-md-8 mx-auto">
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <h5 class="card-title fw-bold mb-3">
                        <i class="bi bi-info-circle-fill text-primary me-2"></i>
                        How It Works
                    </h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="me-3">
                                    <span class="badge bg-primary rounded-circle p-2">1</span>
                                </div>
                                <div>
                                    <h6 class="fw-bold">Choose a Loan Package</h6>
                                    <p class="small text-muted mb-0">Select a loan amount that suits your needs</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="me-3">
                                    <span class="badge bg-primary rounded-circle p-2">2</span>
                                </div>
                                <div>
                                    <h6 class="fw-bold">Pay Savings Amount</h6>
                                    <p class="small text-muted mb-0">Pay only the savings portion to qualify</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="me-3">
                                    <span class="badge bg-primary rounded-circle p-2">3</span>
                                </div>
                                <div>
                                    <h6 class="fw-bold">Receive Loan & Savings</h6>
                                    <p class="small text-muted mb-0">Get both the loan amount and savings in your account</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="d-flex">
                                <div class="me-3">
                                    <span class="badge bg-primary rounded-circle p-2">4</span>
                                </div>
                                <div>
                                    <h6 class="fw-bold">Withdraw Instantly</h6>
                                    <p class="small text-muted mb-0">Access your funds immediately after payment</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Key Points -->
                    <div class="mt-4 pt-3 border-top">
                        <h6 class="fw-bold mb-2">Key Benefits:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span class="small">Pay only the savings amount shown</span>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span class="small">Receive full loan amount immediately</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span class="small">Savings added to your balance</span>
                                </div>
                                <div class="d-flex align-items-center mb-2">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <span class="small">Instant processing after payment</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS: Simple tracking -->
<script>
    // Track payment clicks
    document.addEventListener('DOMContentLoaded', function() {
        const paymentButtons = document.querySelectorAll('[href="https://me.nestlink.co.ke/Maramkopo"]');
        paymentButtons.forEach(button => {
            button.addEventListener('click', function() {
                const modal = this.closest('.modal-content');
                const loanAmount = modal.querySelector('.alert-info').textContent.match(/Loan Amount: Ksh (\d+[\.,]\d+)/);
                const savingsAmount = modal.querySelector('.alert-info').textContent.match(/Savings Required: Ksh (\d+[\.,]\d+)/);
                
                if (loanAmount && savingsAmount) {
                    console.log('Payment initiated for:', {
                        loanAmount: loanAmount[1],
                        savingsAmount: savingsAmount[1]
                    });
                    
                    // Save to localStorage for tracking
                    localStorage.setItem('last_payment_attempt', JSON.stringify({
                        loanAmount: loanAmount[1],
                        savingsAmount: savingsAmount[1],
                        timestamp: new Date().toISOString()
                    }));
                }
            });
        });
    });

    // Initialize tooltips if any
    $(function () {
        $('[data-toggle="tooltip"]').tooltip();
    });
</script>

<style>
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border-radius: 12px;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .modal-content {
        border-radius: 16px;
        overflow: hidden;
    }
    
    .btn-success {
        background: linear-gradient(135deg, #198754 0%, #157347 100%);
        border: none;
        transition: all 0.3s ease;
        font-weight: 600;
        box-shadow: 0 4px 6px rgba(25, 135, 84, 0.2);
    }
    
    .btn-success:hover {
        background: linear-gradient(135deg, #157347 0%, #0f5132 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(25, 135, 84, 0.3);
    }
    
    .step-number {
        font-weight: bold;
        font-size: 14px;
    }
    
    .step-content h6 {
        color: #333;
        font-size: 15px;
    }
    
    .alert-primary {
        border-left: 4px solid #0d6efd;
    }
    
    .alert-success {
        border-left: 4px solid #198754;
    }
    
    .badge.bg-primary {
        background-color: #0d6efd !important;
    }
    
    .text-success {
        color: #198754 !important;
    }
</style>
{% endblock %}